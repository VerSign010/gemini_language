{% extends "base.html" %}

{% block title %}Gemini 三语对齐工具{% endblock %}

{% block head_styles %}
<style>
    /* ---------------------------------- */
    /* ---      最终、更美观的样式      --- */
    /* ---------------------------------- */
    .container {
        max-width: 1140px;
    }
    .card + .card {
        margin-top: 1.5rem;
    }
    .card-header h4 {
        margin-bottom: 0;
    }
    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .control-group label {
        font-weight: 500;
        color: #495057;
    }
    .interval-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* --- 这里是核心修改 --- */
    /* 将 io-grid 直接定义为两列，让子元素自然填充 */
    .io-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 强制两列布局 */
        gap: 1.5rem;
        /* 将诊断模式放在新的一行 */
        grid-template-areas:
            "doc sheet"
            "diag diag";
    }
    /* 分别为 Doc 和 Sheet 指定网格区域 */
    #doc-group { grid-area: doc; }
    #sheet-group { grid-area: sheet; }
    #diag-group { grid-area: diag; }
    /* -------------------- */

    .diagnostic-mode {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: #fff3cd;
        padding: 0.75rem;
        border-radius: 0.375rem;
    }
    .button-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .log-box {
        height: 350px;
        overflow-y: scroll;
        border: 1px solid #dee2e6;
        padding: 1rem;
        background-color: #f8f9fa;
        font-family: monospace;
        white-space: pre-wrap;
        border-radius: 0.375rem;
    }
    .status-bar {
        min-height: 48px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        border-radius: 5px;
        padding: 10px;
        font-size: 1.1em;
        font-weight: 500;
        margin-top: 1.5rem;
    }
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #0d6efd;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-5">Gemini 三语对齐工具</h1>
        <p class="lead text-muted">通过 Google Doc 实现的自动化、批处理对齐流程</p>
    </div>

    <!-- 第一板块：初始化设置 -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h4>⚙️ 初始设置</h4>
        </div>
        <div class="card-body">
            <div class="control-grid">
                <div class="control-group">
                    <label for="model-selector">Gemini 模型:</label>
                    <select id="model-selector" class="form-select">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                        <option value="gemini-pro">Gemini 1.0 Pro</option>
                        <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="temperature-slider">Temperature: <span id="temperature-value">0.00</span></label>
                    <input type="range" class="form-range" id="temperature-slider" min="0" max="1" step="0.05" value="0.2">
                </div>
                <div class="control-group">
                    <label for="batch-size">批次大小 (段落数):</label>
                    <input type="number" id="batch-size" class="form-control" value="1" min="1">
                </div>
                <div class="control-group">
                    <label>批次间随机间隔 (秒):</label>
                    <div class="interval-group">
                        <input type="number" id="interval-min" class="form-control" value="10" min="0">
                        <span>-</span>
                        <input type="number" id="interval-max" class="form-control" value="20" min="0">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第二板块：输入与输出 -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h4>🔗 输入与输出</h4>
        </div>
        <div class="card-body">
            <!-- --- 这里是核心修改 --- -->
            <div class="io-grid">
                <div id="doc-group" class="control-group">
                    <label for="docUrl">源 Google Doc 链接:</label>
                    <input type="url" class="form-control" id="docUrl" placeholder="粘贴 Google Doc 链接...">
                </div>
                <div id="sheet-group" class="control-group">
                    <label for="sheetUrl">目标 Google Sheet 链接:</label>
                    <input type="url" class="form-control" id="sheetUrl" placeholder="粘贴 Google Sheet 链接...">
                </div>
                <div id="diag-group" class="diagnostic-mode">
                    <input type="checkbox" id="diagnostic-mode-checkbox" class="form-check-input">
                    <label for="diagnostic-mode-checkbox" class="form-check-label">开启诊断模式</label>
                </div>
            </div>
            <!-- -------------------- -->
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="button-container">
        <button id="start-button" class="btn btn-success btn-lg">🚀 开始自动化处理</button>
        <button id="stop-button" class="btn btn-danger btn-lg" disabled>🛑 停止处理</button>
    </div>

    <!-- 状态和日志 -->
    <div id="status-bar" class="status-bar">准备就绪</div>
    <div class="mt-3">
        <h5>处理日志</h5>
        <div id="logBox" class="log-box">等待任务开始...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // JavaScript 部分与上一版完全相同，无需修改
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const logBox = document.getElementById('logBox');
    const statusBar = document.getElementById('status-bar');
    const temperatureSlider = document.getElementById('temperature-slider');
    const temperatureValueSpan = document.getElementById('temperature-value');
    const diagnosticCheckbox = document.getElementById('diagnostic-mode-checkbox');

    const settingsInputs = {
        model: document.getElementById('model-selector'),
        temperature: temperatureSlider,
        batchSize: document.getElementById('batch-size'),
        intervalMin: document.getElementById('interval-min'),
        intervalMax: document.getElementById('interval-max'),
        docUrl: document.getElementById('docUrl'),
        sheetUrl: document.getElementById('sheetUrl')
    };
    const SETTINGS_KEY = 'alignerToolSettings_ServiceAccount_v2';

    let isProcessing = false;

    function saveSettings() {
        const currentSettings = {};
        for (const key in settingsInputs) { currentSettings[key] = settingsInputs[key].value; }
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
    }

    function loadSettings() {
        const savedSettingsJSON = localStorage.getItem(SETTINGS_KEY);
        if (savedSettingsJSON) {
            const savedSettings = JSON.parse(savedSettingsJSON);
            for (const key in savedSettings) { if (settingsInputs[key]) { settingsInputs[key].value = savedSettings[key]; } }
            temperatureValueSpan.textContent = parseFloat(settingsInputs.temperature.value).toFixed(2);
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadSettings);
    startButton.addEventListener('click', startAutomation);
    stopButton.addEventListener('click', stopAutomation);
    temperatureSlider.addEventListener('input', () => { temperatureValueSpan.textContent = parseFloat(settingsInputs.temperature.value).toFixed(2); });
    Object.values(settingsInputs).forEach(input => {
        const eventType = (input.type.match(/range|text|url|number/)) ? 'input' : 'change';
        input.addEventListener(eventType, saveSettings);
    });

    function stopAutomation() {
        if (isProcessing) {
            isProcessing = false;
            statusBar.innerHTML = '<span>正在发送停止信号...</span>';
            stopButton.disabled = true;
        }
    }

    function updateButtonStates(processing) {
        isProcessing = processing;
        startButton.disabled = processing;
        stopButton.disabled = !processing;
    }

    function logMessage(message) {
        logBox.textContent += message + '\n';
        logBox.scrollTop = logBox.scrollHeight;
    }
    
    function startAutomation() {
        if (isProcessing) return;
        updateButtonStates(true);
        logBox.textContent = '';
        logMessage('正在启动任务...');
        statusBar.innerHTML = '<div class="loader"></div><span>正在连接服务器...</span>';

        const params = {
            doc_url: settingsInputs.docUrl.value,
            sheet_url: settingsInputs.sheetUrl.value,
            model_name: settingsInputs.model.value,
            temperature: parseFloat(settingsInputs.temperature.value),
            batch_size: parseInt(settingsInputs.batchSize.value, 10),
            interval_min: parseInt(settingsInputs.intervalMin.value, 10),
            interval_max: parseInt(settingsInputs.intervalMax.value, 10),
            diagnostic_mode: diagnosticCheckbox.checked
        };
        
        if (!params.doc_url || !params.sheet_url) {
            alert('请提供 Google Doc 和 Google Sheet 的链接。');
            updateButtonStates(false);
            return;
        }

        fetch('/process_doc_to_sheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        })
        .then(response => {
            if (!response.ok) { throw new Error(`服务器错误: ${response.status}. 请检查后端日志。`); }
            if (!response.body) { throw new Error('响应流不可用。'); }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function processStream() {
                if (!isProcessing) {
                    reader.cancel();
                    logMessage('\n处理已停止。');
                    statusBar.innerHTML = '<span>处理已停止。</span>';
                    updateButtonStates(false);
                    return;
                }
                reader.read().then(({ done, value }) => {
                    if (done) {
                        if (isProcessing) {
                            logMessage('\n任务流结束。');
                            statusBar.innerHTML = '<span>任务完成！</span>';
                        }
                        updateButtonStates(false);
                        return;
                    }
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6).trim();
                            logMessage(message);
                            statusBar.innerHTML = `<span>${message.split('\n')[0]}</span>`;
                        }
                    });
                    processStream();
                });
            }
            processStream();
        })
        .catch(error => {
            logMessage(`\n[致命错误] 请求失败: ${error.message}`);
            statusBar.innerHTML = `<span>请求失败！</span>`;
            updateButtonStates(false);
        });
    }
</script>
{% endblock %}